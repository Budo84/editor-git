<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proflama Editor Stable</title>
    <link rel="icon" type="image/png" href="icon.png">
    <meta name="theme-color" content="#3b82f6">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: false });
        window.mermaid = mermaid;
    </script>

    <style>
        body { height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        #editor-area { flex: 1; display: flex; overflow: hidden; position: relative; }
        textarea { resize: none; outline: none; transition: all 0.2s; }
        .modal { transition: opacity 0.2s ease-in-out; }
        .modal.hidden { opacity: 0; pointer-events: none; }
        .modal:not(.hidden) { opacity: 1; pointer-events: auto; }

        /* Typography & Preview */
        .prose { padding-bottom: 5rem; }
        .prose h1 { font-size: 2em; font-weight: bold; margin: 1em 0 0.5em; border-bottom: 1px solid #eee; color: #1e3a8a; }
        .prose h2 { font-size: 1.5em; font-weight: bold; margin: 1em 0 0.5em; color: #1e40af; }
        .prose h3 { font-size: 1.25em; font-weight: bold; margin: 1em 0 0.5em; color: #2563eb; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .prose ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 1em; }
        .prose p { margin-bottom: 1em; line-height: 1.6; }
        .prose blockquote { border-left: 4px solid #e5e7eb; padding-left: 1em; color: #4b5563; font-style: italic; }
        .prose code { background-color: #f3f4f6; padding: 0.2em 0.4em; border-radius: 4px; font-family: monospace; color: #e11d48; font-size: 0.9em; }
        .prose pre { background-color: #1f2937; color: white; padding: 1em; border-radius: 8px; overflow-x: auto; margin-bottom: 1em; }
        .prose pre code { background-color: transparent; color: inherit; padding: 0; }
        .prose img, .prose video { max-width: 100%; border-radius: 8px; margin: 1em 0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .prose a { color: #2563eb; text-decoration: underline; }

        /* Custom Box */
        .custom-block { padding: 1rem; border-radius: 8px; margin: 1rem 0; border-left: 4px solid; background-color: #f9fafb; }
        .custom-block-title { font-weight: bold; margin-bottom: 0.5rem; display: block; }
        .tip { border-color: #10b981; background-color: #ecfdf5; }
        .warning { border-color: #f59e0b; background-color: #fffbeb; }
        .danger { border-color: #ef4444; background-color: #fef2f2; }
        .info { border-color: #3b82f6; background-color: #eff6ff; }
        
        .fmt-btn { @apply p-1.5 text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded text-sm font-semibold border border-transparent hover:border-blue-100 transition min-w-[30px] flex justify-center items-center; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

    <header class="bg-white border-b p-3 shadow-sm flex flex-col gap-3 z-10 shrink-0">
        <div class="flex flex-wrap gap-2 items-center justify-between sm:justify-start">
            <div class="flex items-center gap-2">
                <a href="tools.html" class="bg-indigo-50 text-indigo-700 px-3 py-1.5 rounded-lg text-xs font-bold border border-indigo-200 hover:bg-indigo-100 transition no-underline">üõ†Ô∏è</a>
                <button onclick="openModal('meta-modal')" class="bg-blue-100 text-blue-700 px-3 py-1.5 rounded-lg text-xs font-bold border border-blue-200 hover:bg-blue-200">üìù Dati</button>
                <button onclick="openModal('media-modal')" class="bg-amber-100 text-amber-800 px-3 py-1.5 rounded-lg text-xs font-bold border border-amber-200 hover:bg-amber-200">üì∑ Media</button>
                <button onclick="openFileManager()" class="bg-slate-100 text-slate-800 px-3 py-1.5 rounded-lg text-xs font-bold border border-slate-200 hover:bg-slate-200">üìÇ File</button>
            </div>

            <button id="mobile-toggle-btn" onclick="toggleMobileView()" class="md:hidden bg-purple-100 text-purple-800 px-3 py-1.5 rounded-lg text-xs font-bold ml-auto">üëÅÔ∏è Anteprima</button>

            <div class="hidden sm:flex flex-col flex-grow md:flex-grow-0 relative ml-2">
                <div class="flex items-center gap-2">
                    <div class="flex">
                        <input type="text" id="gh-path" placeholder="docs/blog/nome.md" class="border rounded-l px-2 py-1 text-sm w-32 lg:w-56 focus:border-blue-500 outline-none font-mono bg-gray-50">
                        <button onclick="loadFromGitHub()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 text-xs font-bold border-y border-r border-gray-300 rounded-r">üìÇ</button>
                    </div>
                    <button onclick="renderPreview()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 text-xs font-bold rounded shadow ml-2 transition">üîÑ Aggiorna</button>
                </div>
            </div>
            
            <div class="flex items-center gap-2 ml-auto sm:ml-2">
                <span id="word-count" class="text-xs text-gray-400 font-mono hidden lg:inline mr-2">0 parole</span>
                <button onclick="deleteFile()" class="p-2 text-red-600 hover:bg-red-50 rounded border border-transparent hover:border-red-200 transition" title="Elimina file">üóëÔ∏è</button>
                <button onclick="syncTextToGitHub()" id="save-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded shadow text-sm font-bold transition">Salva</button>
            </div>
        </div>
    </header>

    <div id="meta-modal" class="modal hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden flex flex-col">
            <div class="bg-blue-50 p-4 border-b flex justify-between items-center"><h3 class="font-bold text-lg text-blue-800">üìù Dati Articolo</h3><button onclick="closeModal('meta-modal')" class="text-blue-400 hover:text-blue-600 text-2xl leading-none">&times;</button></div>
            <div class="p-6 space-y-4 overflow-y-auto max-h-[80vh]">
                <div><label class="block text-xs font-bold text-gray-500 uppercase">Titolo</label><input type="text" id="meta-title" class="w-full border rounded px-3 py-2 font-bold" oninput="autoUpdateFilename()"></div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase">Descrizione</label><textarea id="meta-desc" rows="2" class="w-full border rounded px-3 py-2"></textarea></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-gray-500 uppercase">Categoria</label><select id="meta-cat" class="w-full border rounded px-3 py-2 bg-white"><option value="Microbit">Microbit</option><option value="Arduino">Arduino</option><option value="Mbot">Mbot</option><option value="Scratch">Scratch</option><option value="Elettronica">Elettronica</option></select></div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Target Classe</label><div class="flex flex-wrap gap-2 bg-white border rounded px-3 py-2"><label class="flex items-center gap-1 text-sm"><input type="checkbox" name="target-opt" value="1" class="rounded text-blue-600"> 1</label><label class="flex items-center gap-1 text-sm"><input type="checkbox" name="target-opt" value="2" class="rounded text-blue-600"> 2</label><label class="flex items-center gap-1 text-sm"><input type="checkbox" name="target-opt" value="3" class="rounded text-blue-600"> 3</label><label class="flex items-center gap-1 text-sm"><input type="checkbox" name="target-opt" value="Elementari" class="rounded text-blue-600"> Elem</label><label class="flex items-center gap-1 text-sm"><input type="checkbox" name="target-opt" value="Tutti" class="rounded text-blue-600"> Tutti</label></div></div>
                </div>
                <div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-gray-500 uppercase">Data</label><input type="date" id="meta-date" class="w-full border rounded px-3 py-2"></div><div><label class="block text-xs font-bold text-gray-500 uppercase">Bozza</label><select id="meta-draft" class="w-full border rounded px-3 py-2 bg-white"><option value="false">Pubblico</option><option value="true">Bozza</option></select></div></div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase">Copertina</label><input type="text" id="meta-image" value="/img/default.jpg" class="w-full border rounded px-3 py-2 font-mono text-sm bg-gray-50"></div>
                <button onclick="applyMetadata()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition">‚¨áÔ∏è Inserisci</button>
            </div>
        </div>
    </div>
    <div id="media-modal" class="modal hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden flex flex-col">
            <div class="bg-amber-50 p-4 border-b flex justify-between items-center"><h3 class="font-bold text-lg text-amber-800">üì∑ Carica Media</h3><button onclick="closeModal('media-modal')" class="text-amber-400 hover:text-amber-600 text-2xl leading-none">&times;</button></div>
            <div class="p-6 space-y-6">
                <div class="flex items-center gap-2 bg-gray-50 p-3 rounded-lg border"><span class="text-xs font-bold text-gray-500 uppercase">Cartella:</span><input type="text" id="gh-img-base" value="docs/public/img/" class="flex-1 bg-transparent outline-none text-sm font-mono"></div>
                <div class="border-2 border-dashed border-amber-300 rounded-xl p-10 text-center hover:bg-amber-50 transition relative bg-white group">
                    <input type="file" id="modal-file-input" class="absolute inset-0 opacity-0 cursor-pointer" accept="image/*,video/mp4,video/webm" multiple>
                    <div class="pointer-events-none group-hover:scale-105 transition-transform"><div class="text-5xl mb-3">üì§</div><span class="font-bold text-gray-600 block">Scegli File (Multiplo)</span></div>
                </div>
                <details class="group pt-4 border-t"><summary class="cursor-pointer text-xs font-bold text-gray-400 uppercase list-none text-center">üîê Configurazione</summary><div class="grid gap-2 mt-3 bg-gray-50 p-3 rounded"><input type="password" id="gh-token" placeholder="Token" class="border rounded px-2 py-1 text-xs"><div class="flex gap-2"><input type="text" id="gh-owner" placeholder="User" class="border w-1/2 px-2 py-1 text-xs"><input type="text" id="gh-repo" placeholder="Repo" class="border w-1/2 px-2 py-1 text-xs"></div></div></details>
            </div>
        </div>
    </div>
    <div id="file-modal" class="modal hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-4xl h-[80vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col">
            <div class="bg-slate-800 text-white p-4 border-b flex justify-between items-center"><h3 class="font-bold text-lg">üìÇ File Manager</h3><button onclick="closeModal('file-modal')" class="text-slate-400 hover:text-white text-2xl leading-none">&times;</button></div>
            <div class="bg-slate-100 p-2 flex items-center gap-2 border-b flex-wrap"><button onclick="fmUp()" class="bg-white border rounded px-3 py-1 text-sm">‚¨ÜÔ∏è</button><input type="text" id="fm-search" oninput="fmFilter()" placeholder="üîç Cerca..." class="border rounded px-2 py-1 text-sm w-32 focus:w-48 transition-all outline-none"><input type="text" id="fm-path" class="flex-1 border rounded px-3 py-1 text-sm font-mono" readonly><button onclick="fmCreateFolder()" class="bg-green-100 text-green-700 border border-green-200 rounded px-3 py-1 text-sm font-bold">+ Folder</button><button onclick="fmRefresh()" class="bg-white border rounded px-3 py-1 text-sm">üîÑ</button></div>
            <div id="fm-list" class="flex-1 overflow-y-auto p-4 bg-white grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 content-start"></div>
        </div>
    </div>

    <div id="editor-area">
        <div id="editor-col" class="w-full md:w-1/2 h-full flex flex-col border-r bg-white">
            <div class="flex items-center gap-1 p-2 bg-gray-50 border-b overflow-x-auto shrink-0">
                <button onclick="fmt('**', '**')" class="fmt-btn font-bold">B</button>
                <button onclick="fmt('*', '*')" class="fmt-btn italic">I</button>
                <div class="w-px h-4 bg-gray-300 mx-1"></div>
                <button onclick="fmt('# ', '')" class="fmt-btn">H1</button>
                <button onclick="fmt('## ', '')" class="fmt-btn">H2</button>
                <button onclick="fmt('### ', '')" class="fmt-btn">H3</button>
                <div class="w-px h-4 bg-gray-300 mx-1"></div>
                <button onclick="fmt('- ', '')" class="fmt-btn">List</button>
                <button onclick="fmt('1. ', '')" class="fmt-btn">1.</button>
                <div class="w-px h-4 bg-gray-300 mx-1"></div>
                <button onclick="fmt('[', '](url)')" class="fmt-btn">üîó</button>
                <button onclick="insertYouTube()" class="fmt-btn text-red-600">‚ñ∂Ô∏è YT</button>
                <button onclick="insertTable()" class="fmt-btn">üìä Tab</button>
                <div class="w-px h-4 bg-gray-300 mx-1"></div>
                <button onclick="fmt('`', '`')" class="fmt-btn font-mono" title="Inline">`</button>
                <button onclick="fmt('```\\n', '\\n```')" class="fmt-btn font-mono" title="Block">{ }</button>
                <button onclick="fmt('```cpp\\n', '\\n```')" class="fmt-btn font-mono text-blue-600" title="C++">C++</button>
                <button onclick="fmt('```python\\n', '\\n```')" class="fmt-btn font-mono text-yellow-600" title="Python">Py</button>
                <div class="w-px h-4 bg-gray-300 mx-1"></div>
                <button onclick="insertTemplate()" class="fmt-btn bg-indigo-50 text-indigo-700 border-indigo-100 w-auto px-2 font-bold" title="Inserisci Modello">üìã Modello</button>
                <button onclick="fmt('::: tip üí° CONSIGLIO\\n', '\\n:::\\n')" class="fmt-btn text-emerald-600 bg-emerald-50 hover:bg-emerald-100">üí°</button>
                <button onclick="fmt('::: warning ‚ö†Ô∏è ATTENZIONE\\n', '\\n:::\\n')" class="fmt-btn text-amber-600 bg-amber-50 hover:bg-amber-100">‚ö†Ô∏è</button>
                <button onclick="fmt('::: danger üî• PERICOLO\\n', '\\n:::\\n')" class="fmt-btn text-red-600 bg-red-50 hover:bg-red-100">üî•</button>
            </div>
            <textarea id="markdown-input" class="flex-1 p-6 font-mono text-sm leading-relaxed text-gray-800 resize-none outline-none focus:bg-gray-50" placeholder="Caricamento librerie..."></textarea>
        </div>

        <div id="preview-output" class="hidden md:block w-full md:w-1/2 h-full p-6 overflow-y-auto bg-gray-50 prose max-w-none"></div>

        <div id="loading-overlay" class="hidden absolute inset-0 bg-white/80 z-20 flex items-center justify-center backdrop-blur-sm">
            <div class="bg-white px-6 py-4 rounded-lg shadow-xl border flex flex-col items-center gap-3">
                 <svg class="animate-spin h-8 w-8 text-blue-600" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                 <span id="loading-msg" class="font-semibold text-gray-800 text-sm">Elaborazione...</span>
            </div>
        </div>
    </div>

    <div id="status-msg" class="fixed bottom-5 right-5 transform transition-all duration-300 translate-y-20 opacity-0 z-50 pointer-events-none">
        <div class="bg-gray-800 text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 text-sm font-medium"><span id="status-icon"></span><span id="status-text">Messaggio</span></div>
    </div>

    <script>
        const input = document.getElementById('markdown-input');
        const preview = document.getElementById('preview-output');
        const editorCol = document.getElementById('editor-col');
        
        // --- 1. INIT & EVENTS ---
        window.addEventListener('load', () => {
            ['gh-token', 'gh-owner', 'gh-repo', 'gh-path', 'gh-img-base'].forEach(id => {
                const saved = localStorage.getItem('my_' + id);
                if (saved) document.getElementById(id).value = saved;
                document.getElementById(id).addEventListener('input', (e) => localStorage.setItem('my_' + id, e.target.value));
            });
            document.getElementById('meta-date').valueAsDate = new Date();
            
            const savedDraft = localStorage.getItem('autosave_draft');
            if (savedDraft && savedDraft.length > 10) {
                if(confirm("Bozza trovata. Recuperare?")) {
                    input.value = savedDraft;
                    renderPreview();
                }
            } else {
                renderPreview();
            }
        });

        input.addEventListener('input', () => {
            localStorage.setItem('autosave_draft', input.value);
            // Word Count
            const text = input.value;
            const words = text.trim().split(/\s+/).length;
            const time = Math.ceil(words / 200);
            document.getElementById('word-count').innerText = `${words} parole (~${time} min)`;
            renderPreview();
        });

        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); syncTextToGitHub(); }
            if ((e.ctrlKey || e.metaKey) && e.key === 'b') { e.preventDefault(); fmt('**', '**'); }
            if ((e.ctrlKey || e.metaKey) && e.key === 'i') { e.preventDefault(); fmt('*', '*'); }
        });

        input.addEventListener('paste', async (e) => {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            const files = [];
            for (const item of items) if (item.kind === 'file' && item.type.startsWith('image/')) files.push(item.getAsFile());
            if (files.length > 0) {
                e.preventDefault();
                if(confirm(`Caricare ${files.length} immagini?`)) for (const f of files) await handleFileUploadLogic(f, true);
            }
        });

        // --- 2. LOGICA ANTEPRIMA (RIPARATA) ---
        // Funzione per preprocessare i box colorati (::: tip) PRIMA di Marked
        // Questo risolve i crash delle nuove versioni di marked.js
        function preProcessMarkdown(text) {
            // Regex per trovare blocchi ::: tipo ... :::
            // Sostituisce con <div class="custom-block type"><span...>TITLE</span>content</div>
            return text.replace(/^::: (\w+) (.*)\n([\s\S]*?)\n:::$/gm, (match, type, title, content) => {
                return `<div class="custom-block ${type}"><span class="custom-block-title">${title || type.toUpperCase()}</span>\n${content}\n</div>`;
            });
        }

        async function renderPreview() {
            if (typeof marked === 'undefined') {
                preview.innerHTML = `<div class="p-4 text-red-600 font-bold bg-red-50 border border-red-200 rounded">‚ö†Ô∏è Attendere caricamento librerie...</div>`;
                return;
            }

            // 1. Rimuovi Frontmatter (YAML)
            let content = input.value.replace(/^\s*---[\s\S]*?---\s*/, '');
            
            // 2. Pre-processa i box colorati
            content = preProcessMarkdown(content);

            try {
                // 3. Converti Markdown -> HTML
                preview.innerHTML = marked.parse(content);
                
                // 4. Formule (MathJax)
                if (window.MathJax && window.MathJax.typesetPromise) {
                    MathJax.typesetPromise([preview]).catch(() => {});
                }

                // 5. Diagrammi (Mermaid)
                if (window.mermaid) {
                    const graphs = document.querySelectorAll('.language-mermaid');
                    graphs.forEach(async (graph, index) => {
                        try {
                            const { svg } = await window.mermaid.render('mermaid-' + index, graph.innerText);
                            graph.parentElement.innerHTML = svg;
                        } catch (e) { console.log("Mermaid:", e); }
                    });
                }
            } catch (e) {
                console.error(e);
                preview.innerHTML += `<div class="text-red-500 text-xs mt-2">Errore Render: ${e.message}</div>`;
            }
        }

        // --- TOOLBAR ---
        function fmt(s, e) {
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const val = input.value;
            const r = s + val.substring(start, end) + e;
            input.value = val.substring(0, start) + r + val.substring(end);
            input.selectionStart = input.selectionEnd = start + r.length;
            input.focus();
            renderPreview();
        }
        function insertTemplate() { fmt(`\n### INTRODUZIONE TEORICA\nConcetto...\n\n### MONTAGGIO (Tinkercad)\n#### 1. Componenti\n* 1x **Micro:bit**\n\n#### 2. Cablaggio\n1. Collega...\n\n<center>\n\t<img src="img/robotica/demo.png" alt="circuito" width="300"/>\n</center>\n\n### CODICE\n...\n`, ''); }
        function insertYouTube() { const u = prompt("Link YouTube:"); if(!u) return; let v = u.split('v=')[1] || u.split('/').pop(); v = v.split('&')[0]; fmt(`\n<div style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;"><iframe src="https://www.youtube.com/embed/${v}" style="position:absolute;top:0;left:0;width:100%;height:100%;border:0;" allowfullscreen></iframe></div>\n`, ''); }
        function insertTable() { fmt(`\n| A | B |\n|---|---|\n| 1 | 2 |\n`, ''); }

        // --- UTILS ---
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function b64EncodeUnicode(str) { return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (m, p1) => String.fromCharCode('0x' + p1))); }
        function b64DecodeUnicode(str) { return decodeURIComponent(Array.prototype.map.call(atob(str), (c) => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')); }
        function getCreds() { return { token: document.getElementById('gh-token').value.trim(), owner: document.getElementById('gh-owner').value.trim(), repo: document.getElementById('gh-repo').value.trim() }; }
        function showStatus(msg, type='success') { const el = document.getElementById('status-msg'); el.firstElementChild.className = type==='error'?"bg-red-600 text-white px-4 py-3 rounded shadow flex gap-3":"bg-emerald-600 text-white px-4 py-3 rounded shadow flex gap-3"; document.getElementById('status-icon').innerText = type==='error'?'‚ö†Ô∏è':'‚úÖ'; document.getElementById('status-text').innerText = msg; el.classList.remove('translate-y-20', 'opacity-0'); setTimeout(() => el.classList.add('translate-y-20', 'opacity-0'), 4000); }
        function loading(s, m="") { const el=document.getElementById('loading-overlay'); if(s){document.getElementById('loading-msg').innerText=m; el.classList.remove('hidden');}else{el.classList.add('hidden');} }
        function toggleMobileView() { const btn = document.getElementById('mobile-toggle-btn'); if(editorCol.classList.contains('hidden')) { editorCol.classList.remove('hidden'); preview.classList.add('hidden'); btn.innerText="üëÅÔ∏è Anteprima"; } else { renderPreview(); editorCol.classList.add('hidden'); preview.classList.remove('hidden'); btn.innerText="‚úèÔ∏è Editor"; } }

        // --- METADATA ---
        function autoUpdateFilename() { const t = document.getElementById('meta-title').value; const slug = t.toLowerCase().trim().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-'); document.getElementById('gh-path').value = `docs/blog/${slug}.md`; }
        function applyMetadata() {
            const title = document.getElementById('meta-title').value;
            const safeDesc = document.getElementById('meta-desc').value.replace(/'/g, "''");
            const checked = Array.from(document.querySelectorAll('input[name="target-opt"]:checked')).map(c=>c.value);
            const target = checked.length > 0 ? checked.join(', ') : 'Tutti';
            const img = document.getElementById('meta-image').value;
            const t = `---
title: ${title}
description: '${safeDesc}'
draft: ${document.getElementById('meta-draft').value}
date: ${document.getElementById('meta-date').value}
category: ${document.getElementById('meta-cat').value}
class_target: "${target}"
image: ${img}
---

# ${title}

`;
            if(input.value.length>10 && !confirm("Sovrascrivo?")) return;
            input.value = t; renderPreview(); closeModal('meta-modal');
        }

        // --- UPLOAD ---
        document.getElementById('modal-file-input').addEventListener('change', async (e) => { if(e.target.files.length) { for(const f of e.target.files) await handleFileUploadLogic(f, false); e.target.value=''; closeModal('media-modal'); } });
        async function handleFileUploadLogic(file, isPaste) {
            const creds = getCreds(); if (!creds.token) return showStatus("Manca Token", 'error');
            const base = document.getElementById('gh-img-base').value.trim().replace(/\/$/, '') + '/';
            let name = file.name.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9._-]/g, '');
            if (isPaste && (name==='image.png'||name==='Unknown.png')) name = "screenshot_" + Date.now() + ".png";
            loading(true, "Upload " + name);
            try {
                const buf = await file.arrayBuffer(); let bin = ''; new Uint8Array(buf).forEach((b) => bin += String.fromCharCode(b));
                const url = `https://api.github.com/repos/${creds.owner}/${creds.repo}/contents/${base + name}`;
                const res = await fetch(url, { method: 'PUT', headers: {'Authorization': `token ${creds.token}`, 'Content-Type': 'application/json'}, body: JSON.stringify({message: "Upload media", content: btoa(bin)}) });
                if(!res.ok) throw new Error("Err Upload");
                const relPath = '/' + (base + name).replace('docs/public/', '');
                document.getElementById('meta-image').value = relPath; // AUTO COVER
                let tag = file.type.startsWith('video/') ? `\n<video src="${relPath}" autoplay loop muted playsinline width="100%"></video>\n` : `\n<center>\n\t<img src="${relPath}" alt="${name}" width="300"/>\n</center>\n`;
                const s = input.selectionStart; input.value = input.value.substring(0, s) + tag + input.value.substring(input.selectionEnd);
                renderPreview(); showStatus("Fatto!");
            } catch(e) { showStatus(e.message, 'error'); } finally { loading(false); }
        }

        // --- FILE MANAGER & LOAD/SAVE ---
        let fmPathCur = '';
        function openFileManager() { fmNavigate(document.getElementById('gh-img-base').value || ''); openModal('file-modal'); }
        function fmFilter() { const q = document.getElementById('fm-search').value.toLowerCase(); document.querySelectorAll('#fm-list > div').forEach(i => i.style.display = i.innerText.toLowerCase().includes(q) ? 'flex' : 'none'); }
        async function fmNavigate(p) {
            p = p.replace(/^\/|\/$/g, ''); fmPathCur = p; document.getElementById('fm-path').value = p;
            const creds = getCreds(); const list = document.getElementById('fm-list');
            list.innerHTML = '<p class="col-span-full text-center text-gray-400">Loading...</p>';
            try {
                const res = await fetch(`https://api.github.com/repos/${creds.owner}/${creds.repo}/contents/${p}?t=${Date.now()}`, { headers: {'Authorization': `token ${creds.token}`} });
                if(!res.ok) throw new Error("Dir not found");
                const data = await res.json(); if(!Array.isArray(data)) throw new Error("Err Data");
                list.innerHTML = '';
                data.sort((a,b)=>(a.type===b.type)?0:(a.type==='dir'?-1:1)).forEach(i => {
                    const isD = i.type === 'dir'; const div = document.createElement('div');
                    div.className = `border rounded p-2 flex items-center justify-between hover:bg-slate-50 ${isD ? 'bg-indigo-50' : 'bg-white'}`;
                    div.innerHTML = `<div class="flex items-center gap-2 overflow-hidden cursor-pointer flex-1" onclick="${isD?`fmNavigate('${i.path}')`:`fmSelectFile('${i.path}')`}"><span class="text-xl">${isD?'üìÅ':(i.name.match(/\.(png|jpg|gif)$/)?'üñºÔ∏è':'üìÑ')}</span><span class="text-sm truncate">${i.name}</span></div><div class="flex gap-1"><button onclick="fmRename('${i.path}','${i.sha}','${i.type}')" class="p-1 hover:bg-gray-200 rounded">‚úèÔ∏è</button><button onclick="fmDelete('${i.path}','${i.sha}')" class="p-1 hover:bg-red-100 text-red-500 rounded">üóëÔ∏è</button></div>`;
                    list.appendChild(div);
                });
            } catch(e) { list.innerHTML = `<p class="text-red-500 col-span-full">${e.message}</p>`; }
        }
        function fmUp() { if(fmPathCur) fmNavigate(fmPathCur.split('/').slice(0,-1).join('/')); }
        function fmRefresh() { fmNavigate(fmPathCur); }
        function fmSelectFile(p) { if(p.endsWith('.md') && confirm("Aprire?")) { document.getElementById('gh-path').value = p; closeModal('file-modal'); loadFromGitHub(); } }
        async function fmCreateFolder() { const n = prompt("Nome:"); if(!n) return; apiCall('PUT', (fmPathCur?fmPathCur+'/':'')+n+'/.keep', {message:"New Folder", content:""}, ()=>fmRefresh()); }
        async function fmDelete(p,s) { if(confirm("Del?")) apiCall('DELETE', p, {message:"Del", sha:s}, ()=>fmRefresh()); }
        async function fmRename(p,s,t) { if(t==='dir') return alert("No dir rename"); const n = prompt("New Name:", p.split('/').pop()); if(!n) return; const creds = getCreds(); loading(true); try { const g = await fetch(`https://api.github.com/repos/${creds.owner}/${creds.repo}/contents/${p}`,{headers:{'Authorization':`token ${creds.token}`}}); const d = await g.json(); await apiCall('PUT', p.substring(0,p.lastIndexOf('/'))+'/'+n, {message:"Ren", content:d.content}); await apiCall('DELETE', p, {message:"Del Old", sha:s}); fmRefresh(); } catch(e){alert(e);} finally{loading(false);} }
        async function apiCall(m, p, b, cb) { const c = getCreds(); loading(true); try { await fetch(`https://api.github.com/repos/${c.owner}/${c.repo}/contents/${p}`, {method:m, headers:{'Authorization':`token ${c.token}`, 'Content-Type':'application/json'}, body:JSON.stringify(b)}); if(cb) cb(); } catch(e){alert(e);} finally{loading(false);} }
        async function loadFromGitHub() { const c = getCreds(); const p = document.getElementById('gh-path').value.trim(); if(!c.token) return showStatus("No Token", 'error'); loading(true, "Download..."); try { const res = await fetch(`https://api.github.com/repos/${c.owner}/${c.repo}/contents/${p}?t=${Date.now()}`, {headers:{'Authorization':`token ${c.token}`}}); if(!res.ok) throw new Error("404"); input.value = b64DecodeUnicode((await res.json()).content); renderPreview(); showStatus("Caricato!"); } catch(e){ showStatus(e.message, 'error'); } finally{loading(false);} }
        async function syncTextToGitHub() { const c = getCreds(); const p = document.getElementById('gh-path').value.trim(); if(!c.token) return showStatus("No Token", 'error'); const btn = document.getElementById('save-btn'); btn.innerText="‚è≥"; btn.disabled=true; try { let sha = null; try { const r = await fetch(`https://api.github.com/repos/${c.owner}/${c.repo}/contents/${p}`, {headers:{'Authorization':`token ${c.token}`}}); if(r.ok) sha=(await r.json()).sha; } catch(e){} const res = await fetch(`https://api.github.com/repos/${c.owner}/${c.repo}/contents/${p}`, { method: 'PUT', headers: {'Authorization': `token ${c.token}`, 'Content-Type': 'application/json'}, body: JSON.stringify({ message: sha ? `Update ${p}` : `Create ${p}`, content: b64EncodeUnicode(input.value), sha: sha || undefined }) }); if(!res.ok) throw new Error("Err Save"); localStorage.removeItem('autosave_draft'); showStatus("Salvato!"); } catch(e){ showStatus(e.message, 'error'); } finally{ btn.innerText="Salva"; btn.disabled=false; } }
    </script>
</body>
</html>
